#include <conio.h>
#include <stdlib.h>
#include <string.h>
#include <cbm_screen_charmap.h>
#include <c64.h>
/******************/
#define poke(addr,val)  (*(unsigned char *)(addr)=(val))
/*******************
** Prototypes
*******************/
void INITSPRITES(void);
void INITRASTER(void);
/******************/
extern unsigned char SPRX[];
extern unsigned char SPRY[];
extern unsigned char SPRC[];
extern unsigned char SPRF[];
extern unsigned char NUMSPRITES;
extern unsigned char SPRUPDATEFLAG;
extern unsigned char SPRIRQCOUNTER;
extern unsigned char MULTIPLEX_DONE;
#pragma zpsym ("NUMSPRITES")
#pragma zpsym ("SPRUPDATEFLAG")
#pragma zpsym ("MULTIPLEX_DONE")
/***************************************
* Pre-calculated
* sinus values
*******************/
const char yValues[] = {
0x50,0x58,0x60,0x67,0x6f,0x76,0x7c,0x83,
0x89,0x8e,0x93,0x97,0x9a,0x9d,0x9e,0xa0,
0xa0,0xa0,0x9e,0x9d,0x9a,0x97,0x93,0x8e,
0x89,0x83,0x7c,0x76,0x6f,0x67,0x60,0x58,
0x50,0x48,0x40,0x39,0x31,0x2a,0x24,0x1d,
0x17,0x12,0xd,0x9,0x6,0x3,0x2,0x0,
0x0,0x0,0x2,0x3,0x6,0x9,0xd,0x12,
0x17,0x1d,0x24,0x2a,0x31,0x39,0x40,0x48,
0x50,0x58,0x60,0x67,0x6f,0x76,0x7c,0x83,
0x89,0x8e,0x93,0x97,0x9a,0x9d,0x9e,0xa0,
0xa0,0xa0,0x9e,0x9d,0x9a,0x97,0x93,0x8e,
0x89,0x83,0x7c,0x76,0x6f,0x67,0x60,0x58,
0x50,0x48,0x40,0x39,0x31,0x2a,0x24,0x1d,
0x17,0x12,0xd,0x9,0x6,0x3,0x2,0x0,
0x0,0x0,0x2,0x3,0x6,0x9,0xd,0x12,
0x17,0x1d,0x24,0x2a,0x31,0x39,0x40,0x48,
0x50,0x58,0x60,0x67,0x6f,0x76,0x7c,0x83,
0x89,0x8e,0x93,0x97,0x9a,0x9d,0x9e,0xa0,
0xa0,0xa0,0x9e,0x9d,0x9a,0x97,0x93,0x8e,
0x89,0x83,0x7c,0x76,0x6f,0x67,0x60,0x58,
0x50,0x48,0x40,0x39,0x31,0x2a,0x24,0x1d,
0x17,0x12,0xd,0x9,0x6,0x3,0x2,0x0,
0x0,0x0,0x2,0x3,0x6,0x9,0xd,0x12,
0x17,0x1d,0x24,0x2a,0x31,0x39,0x40,0x48,
0x50,0x58,0x60,0x67,0x6f,0x76,0x7c,0x83,
0x89,0x8e,0x93,0x97,0x9a,0x9d,0x9e,0xa0,
0xa0,0xa0,0x9e,0x9d,0x9a,0x97,0x93,0x8e,
0x89,0x83,0x7c,0x76,0x6f,0x67,0x60,0x58,
0x50,0x48,0x40,0x39,0x31,0x2a,0x24,0x1d,
0x17,0x12,0xd,0x9,0x6,0x3,0x2,0x0,
0x0,0x0,0x2,0x3,0x6,0x9,0xd,0x12,
0x17,0x1d,0x24,0x2a,0x31,0x39,0x40,0x48
    };
/***************************************
* Scrolltext
******************/
const char scrolltext[] =
//   0123456789ABCD
    "ciao a tutti !"
    " questo e' un "
    "esempio di sin"
    " scroller basa"
    "to su sprites."
    "              "
    "by flavioweb e"
    "fabrizio carus"
    "o e antonio po"
    "rcino per gli "
    "amici di faceb"
    "ook e non...  "
    "happy hacking!"
    "              ";
/**************************************/
#include <cbm_petscii_charmap.h>
int main()
{    
    unsigned char XX = 0;
    unsigned char SX = 0;
    unsigned short SP = 0;
    unsigned char DL = 0;
    unsigned char i;
/******************/
    poke (0xd020, 0x00);
    poke (0xd021, 0x00);
    clrscr();
    
    INITSPRITES();
    INITRASTER();
    NUMSPRITES = 16;
/**************************************/  
    for(i=0;i<NUMSPRITES;++i)
    {
        SPRF[i] = 0xA0; 
        SPRC[i] = 0X01;        
    }
/******************/
    while(1) 
    {
        if (MULTIPLEX_DONE) {
            gotoxy(1,1); cprintf("%02u",DL);
                        
            if (DL == 24) {
                for(i=2;i<NUMSPRITES;++i)
                {
                    SPRF[i-2]=SPRF[i];
                }
                SPRF[NUMSPRITES-2]=0x80+(scrolltext[SP++]);
                SPRF[NUMSPRITES-1]=0x80+(scrolltext[SP++]);
                if (SP>strlen(scrolltext)) { SP=0; }
                SX = SX-54;
                DL = 0;
            }
            
             for(i=0;i<NUMSPRITES;++i)
            {
                XX = SX+(i*5);
                SPRX[i] = 12+(i*12)-DL;
                SPRY[i] = 60+yValues[XX];
            }                                   
            ++DL;
            ++SX;
            MULTIPLEX_DONE = 0;
            SPRUPDATEFLAG = 1;
        }
    }
    return 0;
}
